<div class="admin-dashboard">
    <header class="dashboard-header">
        <h1>Painel Administrativo - Piá-bot</h1>
        <div class="user-info">
            <span>Olá, {{ userName }}!</span>
            <button (click)="logout()">Sair</button>
        </div>
    </header>

    <main class="dashboard-content">
        <nav class="tabs">
            <button (click)="setActiveTab('history')" [class.active]="activeTab === 'history'">Histórico (por
                Conversa)</button>
            <button (click)="setActiveTab('feed')" [class.active]="activeTab === 'feed'">Feed de Mensagens</button>
            <button (click)="setActiveTab('knowledge')" [class.active]="activeTab === 'knowledge'">Base de
                Conhecimento</button>
            <button (click)="setActiveTab('users')" [class.active]="activeTab === 'users'">Gerenciar Usuários</button>
        </nav>

        <div class="tab-content">
            <!-- CONTEÚDO DA ABA DE HISTÓRICO -->
            <div *ngIf="activeTab === 'history'">
                <h2>Últimas Conversas</h2>

                <!-- MENSAGEM DE CARREGAMENTO -->
                <div *ngIf="isLoading" class="loading-indicator">Carregando histórico...</div>

                <!-- MENSAGEM DE ERRO -->
                <div *ngIf="error" class="error-indicator">{{ error }}</div>


                <table *ngIf="!isLoading && !error">
                    <thead>
                        <tr>
                            <th>ID do Usuário</th>
                            <th>Data</th>
                            <th>Primeira Mensagem</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- MENSAGEM PARA QUANDO NÃO HÁ CONVERSAS -->
                        <tr *ngIf="conversations.length === 0">
                            <td colspan="4" class="no-data">Nenhuma conversa encontrada.</td>
                        </tr>
                        <!-- LOOP PARA EXIBIR AS CONVERSAS -->
                        <tr *ngFor="let convo of conversations">
                            <td>
                                <span class="user-id" title="{{ convo.userId }}">{{ convo.userId | slice:0:15
                                    }}...</span>
                            </td>
                            <td>{{ convo.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
                            <td>"{{ convo.messages[0]?.text | slice:0:50 }}..."</td>
                            <td><button (click)="viewConversation(convo._id)">Visualizar</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- NOVA ABA DE FEED DE MENSAGENS -->
            <div *ngIf="activeTab === 'feed'">
                <h2>Últimas Interações (Feed)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Autor</th>
                            <th>Mensagem</th>
                            <th>ID do Usuário</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let msg of messagesFeed" [ngClass]="'role-' + msg.role">
                            <td>{{ msg.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                            <td>
                                <span class="role-tag">{{ msg.role === 'user' ? 'Usuário' : 'Piá-bot' }}</span>
                            </td>
                            <td>{{ msg.text }}</td>
                            <td>
                                <span class="user-id" title="{{ msg.userId }}">{{ msg.userId | slice:0:8 }}...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- CONTEÚDO DA ABA DE BASE DE CONHECIMENTO -->
            <div *ngIf="activeTab === 'knowledge'">
                <h2>Itens da Base de Conhecimento</h2>

                <!-- NOVO FORMULÁRIO DE ADIÇÃO -->
                <div class="add-knowledge-form">
                    <h3>Adicionar Novo Item</h3>
                    <form (ngSubmit)="onAddKnowledgeSubmit()">
                        <div class="form-group">
                            <label for="new-topic">Tópico</label>
                            <input type="text" id="new-topic" [(ngModel)]="newKnowledgeItem.topic" name="newTopic"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="new-source">Fonte (Ex: Resolução 01/2012, Art. 5º)</label>
                            <input type="text" id="new-source" [(ngModel)]="newKnowledgeItem.source" name="newSource"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="new-content">Conteúdo</label>
                            <textarea id="new-content" [(ngModel)]="newKnowledgeItem.content" name="newContent" rows="4"
                                required></textarea>
                        </div>
                        <button type="submit" [disabled]="isSubmitting">
                            {{ isSubmitting ? 'Adicionando...' : 'Adicionar Item' }}
                        </button>
                        <p *ngIf="formError" class="error-message">{{ formError }}</p>
                    </form>
                </div>

                <hr class="divider">

                <!-- CAMPO DE BUSCA -->
                <div class="search-bar">
                    <input type="text" placeholder="Pesquisar por tópico ou conteúdo..." [(ngModel)]="searchTerm"
                        (input)="onSearch()">
                </div>
                <div class="search-bar">
                    <input type="text" placeholder="Pesquisar por tópico ou conteúdo..." [formControl]="searchControl">
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Tópico</th>
                            <th>Conteúdo</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- MENSAGEM PARA QUANDO A BASE ESTÁ VAZIA -->
                        <tr *ngIf="knowledgeBase.length === 0">
                            <td colspan="4" class="no-data">Nenhum item na base de conhecimento. Execute o script de
                                seed no servidor.</td>
                        </tr>
                        <!-- LOOP PARA EXIBIR OS ITENS -->
                        <tr *ngFor="let item of knowledgeBase">
                            <td><strong>{{ item.topic }}</strong></td>
                            <td>{{ item.content | slice:0:100 }}...</td>
                            <td><span class="source-tag">{{ item.source }}</span></td>
                            <button class="edit" (click)="openEditModal(item)">Editar</button> <!-- NOVO BOTÃO -->
                            <td><button class="danger" (click)="deleteKnowledgeItem(item._id)">Excluir</button></td>
                        </tr>
                    </tbody>
                </table>

            </div>


            <!-- MODAL DE EDIÇÃO -->
            <div class="modal-overlay" *ngIf="editingItem">
                <div class="modal-content">
                    <button class="close-btn" (click)="editingItem = null">&times;</button>
                    <h3>Editando Item</h3>
                    <form (ngSubmit)="onUpdateKnowledgeSubmit()">
                        <div class="form-group">
                            <label for="edit-topic">Tópico</label>
                            <input type="text" id="edit-topic" [(ngModel)]="editingItem.topic" name="editTopic"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="edit-source">Fonte</label>
                            <input type="text" id="edit-source" [(ngModel)]="editingItem.source" name="editSource"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="edit-content">Conteúdo</label>
                            <textarea id="edit-content" [(ngModel)]="editingItem.content" name="editContent" rows="6"
                                required></textarea>
                        </div>
                        <button type="submit" [disabled]="isSubmitting">
                            {{ isSubmitting ? 'Salvando...' : 'Salvar Alterações' }}
                        </button>
                    </form>
                </div>
            </div>

            <!-- CONTEÚDO DA ABA DE USUÁRIOS (placeholder) -->
            <div *ngIf="activeTab === 'users'">
                <h2>Gerenciamento de Usuários</h2>

                <!-- Seção: Alterar Minha Senha -->
                <div class="user-management-section">
                    <h3>Alterar Minha Senha</h3>
                    <form (ngSubmit)="onPasswordChangeSubmit()">
                        <div class="form-group">
                            <label for="currentPassword">Senha Atual</label>
                            <input type="password" id="currentPassword" [(ngModel)]="currentPassword"
                                name="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Nova Senha</label>
                            <input type="password" id="newPassword" [(ngModel)]="newPassword" name="newPassword"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirmar Nova Senha</label>
                            <input type="password" id="confirmNewPassword" [(ngModel)]="confirmNewPassword"
                                name="confirmNewPassword" required>
                        </div>
                        <button type="submit">Alterar Senha</button>
                        <p *ngIf="passwordChangeMessage" class="success-message">{{ passwordChangeMessage }}</p>
                        <p *ngIf="passwordChangeError" class="error-message">{{ passwordChangeError }}</p>
                    </form>
                </div>

                <hr class="divider">

                <!-- Seção: Gerenciar Outros Usuários (APENAS PARA ADMINS) -->
                <div *ngIf="userRole === 'admin'" class="user-management-section">
                    <h3>Gerenciar Outros Usuários</h3>

                    <h4>Adicionar Novo Usuário</h4>
                    <form (ngSubmit)="onNewUserSubmit()">
                        <div class="form-group">
                            <label for="new-user-email">Email</label>
                            <input type="email" id="new-user-email" [(ngModel)]="newUser.email" name="newUserEmail"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="new-user-password">Senha</label>
                            <input type="password" id="new-user-password" [(ngModel)]="newUser.password"
                                name="newUserPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="new-user-name">Nome</label>
                            <input type="text" id="new-user-name" [(ngModel)]="newUser.name" name="newUserName"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="new-user-role">Função</label>
                            <select id="new-user-role" [(ngModel)]="newUser.role" name="newUserRole" required>
                                <option value="viewer">Visualizador</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <button type="submit">Adicionar Usuário</button>
                        <p *ngIf="newUserMessage" class="success-message">{{ newUserMessage }}</p>
                        <p *ngIf="newUserError" class="error-message">{{ newUserError }}</p>
                    </form>

                    <hr class="divider">

                    <h4>Lista de Usuários</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Função</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let user of users">
                                <td>{{ user.name }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.role }}</td>
                                <td>
                                    <button class="danger" (click)="deleteUser(user._id)"
                                        [disabled]="user.role === 'admin' && user.email === userName">Excluir</button>
                                    <!-- O botão de excluir admin está desabilitado para o próprio usuário logado -->
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div *ngIf="userRole !== 'admin'" class="no-privileges">
                    <p>Você não tem privilégios de administrador para gerenciar outros usuários.</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- MODAL PARA VISUALIZAR CONVERSA COMPLETA -->
<div class="modal-overlay" *ngIf="selectedConversation">
    <div class="modal-content">
        <button class="close-btn" (click)="selectedConversation = null">&times;</button>
        <h3>Conversa com {{ selectedConversation.userId }}</h3>
        <div class="message-list">
            <div *ngFor="let msg of selectedConversation.messages" [ngClass]="msg.role">
                <strong>{{ msg.role === 'user' ? 'Usuário' : 'Piá-bot' }}:</strong>
                <p>{{ msg.text }}</p>
            </div>
        </div>
    </div>
</div>